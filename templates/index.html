<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Unraid XML åŠ©æ‰‹</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        :root {
            --unraid-red: #E2211A;
            --unraid-dark: #121212;
            --bg-panel: #1e1e1e;
            --border-color: #333;
            --text-main: #e0e0e0;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: var(--unraid-dark); 
            color: var(--text-main); 
            margin: 0; padding: 20px; 
        }

        .header { display: flex; align-items: center; border-bottom: 2px solid var(--unraid-red); padding-bottom: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; color: var(--unraid-red); }

        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100vh - 150px); }
        
        .panel { display: flex; flex-direction: column; background: var(--bg-panel); border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .panel-header { padding: 10px 15px; background: #252525; border-bottom: 1px solid var(--border-color); font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; }

        textarea { 
            flex: 1; border: none; padding: 15px; background: transparent; color: #76ff03; 
            font-family: 'Fira Code', 'Courier New', monospace; font-size: 13px; resize: none; outline: none;
        }

        /* ä»£ç é«˜äº®åŒºåŸŸæ ·å¼ */
        .code-container { flex: 1; position: relative; overflow: auto; background: #1d1d1d; }
        pre { margin: 0 !important; border-radius: 0 !important; height: 100%; font-size: 13px !important; }

        .toolbar { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        
        button { 
            background: var(--unraid-red); color: white; border: none; padding: 10px 20px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #444; cursor: not-allowed; }
        .btn-save { background: #007bff; }
        
        #statusLabel { font-size: 14px; color: #ff9800; }
        .clear-btn { background: #444; font-size: 12px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>UNRAID XML ASSISTANT</h1>
    </div>

    <div class="toolbar">
        <button onclick="doConvert()">âš¡ è½¬æ¢å¹¶é¢„è§ˆ</button>
        <button id="saveBtn" class="btn-save" onclick="doSave()" disabled>ğŸ’¾ ä¿å­˜åˆ°æ¨¡æ¿åº“</button>
        <button class="clear-btn" onclick="clearAll()">æ¸…ç©º</button>
        <span id="statusLabel"></span>
    </div>

    <div class="container">
        <div class="panel">
            <div class="panel-header">DOCKER COMPOSE (YAML)</div>
            <textarea id="composeInput" placeholder="åœ¨æ­¤ç²˜è´´ Docker Compose å†…å®¹..."></textarea>
        </div>

        <div class="panel">
            <div class="panel-header">PREVIEW (XML)</div>
            <div class="code-container">
                <pre><code id="xmlDisplay" class="language-xml"></code></pre>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-xml-doc.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

    <script>
        let currentName = "";
        let currentXml = "";

        async function doConvert() {
            const text = document.getElementById('composeInput').value;
            const status = document.getElementById('statusLabel');
            const display = document.getElementById('xmlDisplay');
            
            if(!text.trim()) return;
            status.innerText = "æ­£åœ¨è½¬æ¢...";
            
            try {
                const res = await fetch('/convert', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({compose_text: text})
                });
                const data = await res.json();
                
                if(data.success) {
                    currentXml = data.xml;
                    currentName = data.name;
                    // æ›´æ–°ä»£ç å¹¶è§¦å‘ Prism é«˜äº®
                    display.textContent = data.xml;
                    Prism.highlightElement(display);
                    
                    document.getElementById('saveBtn').disabled = false;
                    status.innerText = "è½¬æ¢æˆåŠŸï¼";
                } else {
                    status.innerText = "é”™è¯¯: " + data.error;
                }
            } catch (e) {
                status.innerText = "ç½‘ç»œè¯·æ±‚å¤±è´¥";
            }
        }

        async function doSave() {
            const status = document.getElementById('statusLabel');
            const res = await fetch('/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: currentName, xml: currentXml})
            });
            const data = await res.json();
            if(data.success) {
                status.innerText = "âœ… å·²ä¿å­˜è‡³æ¨¡æ¿ç›®å½•ï¼";
                alert("å·²ä¿å­˜ï¼è¯·å‰å¾€ Unraid 'Add Container' åˆ—è¡¨æŸ¥çœ‹ã€‚");
            } else {
                alert("ä¿å­˜å¤±è´¥: " + data.error);
            }
        }

        function clearAll() {
            document.getElementById('composeInput').value = "";
            document.getElementById('xmlDisplay').textContent = "";
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('statusLabel').innerText = "";
        }
    </script>
</body>
</html>
